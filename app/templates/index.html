{% extends "base.html" %}
{% block content %}
<div class="layout-split">
    <!-- å·¦ä¾§æ–‡ç« åˆ—è¡¨ -->
    <div class="sidebar">
        <h2>ğŸ“š æ–‡ç« åˆ—è¡¨</h2>
        {% if grouped_data %}
            {% for group in grouped_data %}
            {% set cat_id = group.category|replace(' ', '_')|replace('ï¼ˆ', '_')|replace('ï¼‰', '_')|replace('(', '_')|replace(')', '_')|replace('/', '_')|replace('\\', '_') %}
            <div class="article-group">
                <div class="article-group-title collapsible" onclick="toggleGroup('{{ cat_id }}')" id="group-title-{{ cat_id }}">
                    <span class="collapse-arrow" id="arrow-{{ cat_id }}">&gt;</span> {{ group.category }}<span class="group-count">ï¼ˆ{{ group.total_articles }}ï¼‰</span>
                </div>
                <div class="group-content" id="group-content-{{ cat_id }}">
                    <ul class="article-list" id="group-list-{{ cat_id }}">
                        {% for article in group.articles %}
                        <li class="article-item" data-article-id="{{ article.id }}" onclick="loadArticle({{ article.id }})">
                            <div class="article-title">{{ article.title }}</div>
                            <div class="article-meta">
                                <span class="article-author">{{ article.author.username }}</span>
                                <span class="article-date">{{ article.created_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="pagination-controls">
                        {# --- Pagination: << < x > >>, with special cases for x=1 and x=n --- #}
                        {% set n = group.total_pages %}
                        {% set x = group.current_page %}
                        {% set cat = cat_id %}
                        {% if n > 1 %}
                            {% if x == 1 %}
                                <span class="page-link active">1</span>
                                {% if n > 1 %}
                                    <a class="page-link" href="/?page_{{ cat }}={{ x+1 }}#group-{{ cat }}">&gt;</a>
                                    <a class="page-link" href="/?page_{{ cat }}={{ n }}#group-{{ cat }}">&gt;&gt;</a>
                                {% endif %}
                            {% elif x == n %}
                                <a class="page-link" href="/?page_{{ cat }}=1#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ x-1 }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ n }}</span>
                            {% else %}
                                <a class="page-link" href="/?page_{{ cat }}=1#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ x-1 }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ x }}</span>
                                <a class="page-link" href="/?page_{{ cat }}={{ x+1 }}#group-{{ cat }}">&gt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ n }}#group-{{ cat }}">&gt;&gt;</a>
                            {% endif %}
                        {% else %}
                            <span class="page-link active">1</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">æš‚æ— æ–‡ç« </div>
        {% endif %}
    </div>
    
    <!-- å³ä¾§æ–‡ç« å†…å®¹ -->
    <div class="content-area" id="article-content">
        {% if first_article %}
            {% set can_edit = user and first_article.author and user.id == first_article.author.id %}
            {% set article = first_article %}
            {% include "article_content.html" %}
        {% else %}
            <div class="empty-state">
                <h3>ğŸ“– é€‰æ‹©æ–‡ç« </h3>
                <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ç¯‡æ–‡ç« æ¥é˜…è¯»</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// æ–‡ç« ç‚¹å‡»åŠ è½½ä¸é«˜äº®ï¼Œå¹¶è®°å½•åˆ°localStorage
function loadArticle(articleId) {
    document.querySelectorAll('.article-item').forEach(function(item) {
        item.classList.remove('active');
    });
    var currentItem = document.querySelector('[data-article-id="' + articleId + '"]');
    if (currentItem) {
        currentItem.classList.add('active');
    }
    fetch('/article/' + articleId + '/content')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            var contentArea = document.getElementById('article-content');
            contentArea.innerHTML =
                '<div class="card">' +
                (data.can_edit ?
                '<div class="article-actions-top">' +
                    '<a href="/article/' + articleId + '/edit" class="action-link edit">âœï¸ ç¼–è¾‘</a>' +
                    '<span class="action-separator">|</span>' +
                    '<a href="#" onclick="deleteArticle(' + articleId + ')" class="action-link delete">ğŸ—‘ï¸ åˆ é™¤</a>' +
                '</div>' : '') +
                '<h1>' + data.title + '</h1>' +
                '<div class="article-content">' + data.content + '</div>' +
                '<div class="article-meta right">' + data.author + ' â€¢ ' + data.created_at + '</div>' +
                '</div>';
        })
        .catch(function(error) {
            var contentArea = document.getElementById('article-content');
            contentArea.innerHTML =
                '<div class="empty-state">' +
                    '<h3>âŒ åŠ è½½å¤±è´¥</h3>' +
                    '<p>æ— æ³•åŠ è½½æ–‡ç« å†…å®¹ï¼Œè¯·ç¨åé‡è¯•</p>' +
                '</div>';
        });
    localStorage.setItem('currentArticleId', articleId);
}

window.addEventListener('DOMContentLoaded', function() {
    var currentId = localStorage.getItem('currentArticleId');
    var item = null;
    if (currentId) {
        item = document.querySelector('.article-item[data-article-id="' + currentId + '"]');
    }
    if (item) {
        item.classList.add('active');
        loadArticle(currentId);
        item.scrollIntoView({block: 'center'});
    } else {
        // SSR å·²æ¸²æŸ“ç¬¬ä¸€ç¯‡ï¼Œæ— éœ€è‡ªåŠ¨ loadArticle
        var firstItem = document.querySelector('.article-item');
        if (firstItem) {
            firstItem.classList.add('active');
            firstItem.scrollIntoView({block: 'center'});
        }
    }
});

// æŠ˜å /å±•å¼€åˆ†ç»„
function toggleGroup(category) {
    var content = document.getElementById('group-content-' + category);
    var arrow = document.getElementById('arrow-' + category);
    if (content.style.display === 'none') {
        content.style.display = '';
        if (arrow) arrow.innerHTML = "&or;"; // å±•å¼€æ—¶â€œâˆ¨â€
    } else {
        content.style.display = 'none';
        if (arrow) arrow.innerHTML = "&gt;"; // æ”¶èµ·æ—¶â€œ>â€
    }
}

// é¦–é¡µlogoç‚¹å‡»æ—¶æ¸…é™¤localStorageå¹¶åˆ·æ–°
(function() {
    var homeLink = document.getElementById('home-link');
    if (homeLink) {
        homeLink.addEventListener('click', function(e) {
            localStorage.removeItem('currentArticleId');
        });
    }
})();
</script>
<style>
.collapsible {
    cursor: pointer;
    user-select: none;
    font-weight: 400;
    font-size: 1.02em;
    color: #6a7c6a;
    padding: 2px 0 2px 2px;
    display: flex;
    align-items: center;
    transition: color 0.18s;
    border-radius: 4px;
}
.collapsible:hover {
    color: #3d4f3d;
    background: #f6faf6;
}
.collapse-arrow {
    display: inline-block;
    width: 0.9em;
    text-align: center;
    margin-right: 6px;
    font-size: 0.95em;
    color: #b2bdb2;
    font-weight: 300;
    transition: transform 0.2s, color 0.18s;
}
.article-group {
    margin-bottom: 0.7em;
    border: none;
    background: none;
}
.article-list {
    margin-left: 0.5em;
    padding-left: 0.5em;
    border-left: none;
}
.group-count {
    font-size: 0.98em;
    color: #b2bdb2;
    margin-left: 0.3em;
    font-weight: 400;
}
.article-item.active {
    background: #eafbe6;
    border-radius: 4px;
    color: #2d4f2d;
}
</style>
{% endblock %}