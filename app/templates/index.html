{% extends "base.html" %}
{% block content %}
<div class="layout-split">
    <!-- å·¦ä¾§æ–‡ç« åˆ—è¡¨ -->
    <div class="sidebar">
        <h2>ğŸ“š æ–‡ç« åˆ—è¡¨</h2>
        {% if grouped_data %}
            {% for group in grouped_data %}
            {% set cat_id = group.category|replace(' ', '_')|replace('ï¼ˆ', '_')|replace('ï¼‰', '_')|replace('(', '_')|replace(')', '_')|replace('/', '_')|replace('\\', '_') %}
            <div class="article-group">
                <div class="article-group-title collapsible" onclick="toggleGroup('{{ cat_id }}')" id="group-title-{{ cat_id }}">
                    <span class="collapse-arrow" id="arrow-{{ cat_id }}">&gt;</span> {{ group.category }}<span class="group-count">ï¼ˆ{{ group.total_articles }}ï¼‰</span>
                </div>
                <div class="group-content" id="group-content-{{ cat_id }}">
                    <ul class="article-list" id="group-list-{{ cat_id }}">
                        {% for article in group.articles %}
                        <li class="article-item" data-article-id="{{ article.id }}" onclick="loadArticle({{ article.id }})">
                            <div class="article-title">{{ article.title }}</div>
                            <div class="article-meta">
                                <span class="article-author">{{ article.author.username }}</span>
                                <span class="article-date">{{ article.created_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="pagination-controls">
                        {# --- Pagination: << < x > >>, with special cases for x=1 and x=n --- #}
                        {% set n = group.total_pages %}
                        {% set x = group.current_page %}
                        {% set cat = cat_id %}
                        {% if n > 1 %}
                            {% if x == 1 %}
                                <span class="page-link active">1</span>
                                {% if n > 1 %}
                                    <a class="page-link" href="/?page_{{ cat }}={{ x+1 }}#group-{{ cat }}">&gt;</a>
                                    <a class="page-link" href="/?page_{{ cat }}={{ n }}#group-{{ cat }}">&gt;&gt;</a>
                                {% endif %}
                            {% elif x == n %}
                                <a class="page-link" href="/?page_{{ cat }}=1#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ x-1 }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ n }}</span>
                            {% else %}
                                <a class="page-link" href="/?page_{{ cat }}=1#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ x-1 }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ x }}</span>
                                <a class="page-link" href="/?page_{{ cat }}={{ x+1 }}#group-{{ cat }}">&gt;</a>
                                <a class="page-link" href="/?page_{{ cat }}={{ n }}#group-{{ cat }}">&gt;&gt;</a>
                            {% endif %}
                        {% else %}
                            <span class="page-link active">1</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">æš‚æ— æ–‡ç« </div>
        {% endif %}
    </div>
    
    <!-- å³ä¾§æ–‡ç« å†…å®¹ -->
    <div class="content-area" id="article-content">
        {% if first_article is defined and first_article %}
            <div class="card">
                <h1>{{ first_article.title }}</h1>
                <div class="article-content">{{ first_article.content }}</div>
                <div class="article-meta right">
                    {{ first_article.author.username if first_article.author else 'åŒ¿å' }} â€¢ {{ first_article.created_at.strftime('%Y-%m-%d %H:%M') if first_article.created_at else '' }}
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <h3>ğŸ“– é€‰æ‹©æ–‡ç« </h3>
                <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ç¯‡æ–‡ç« æ¥é˜…è¯»</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å˜é‡
var currentArticleId = null;
var currentUser = null; // å°†åœ¨é¡µé¢åŠ è½½æ—¶è®¾ç½®
var currentArticleAuthorId = null; // å½“å‰æ–‡ç« çš„ä½œè€…ID

// æ˜¾ç¤ºç©ºç™½çŠ¶æ€
function showEmptyState() {
    var contentArea = document.getElementById('article-content');
    if (contentArea) {
        contentArea.innerHTML = 
            '<div class="empty-state">' +
                '<h3>ğŸ“– é€‰æ‹©æ–‡ç« </h3>' +
                '<p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ç¯‡æ–‡ç« æ¥é˜…è¯»</p>' +
            '</div>';
    }
}

// åŠ è½½æ–‡ç« å†…å®¹
function loadArticle(articleId) {
    if (!articleId) {
        showEmptyState();
        return;
    }
    
    console.log('DEBUG: loadArticle called with articleId =', articleId);
    
    // æ›´æ–°å½“å‰æ–‡ç« ID
    currentArticleId = articleId;
    
    // æ›´æ–°é«˜äº®çŠ¶æ€
    document.querySelectorAll('.article-item').forEach(function(item) {
        item.classList.remove('active');
    });
    var currentItem = document.querySelector('[data-article-id="' + articleId + '"]');
    if (currentItem) {
        currentItem.classList.add('active');
        currentItem.scrollIntoView({block: 'center'});
        console.log('DEBUG: é«˜äº®æ–‡ç« ', articleId, 'æˆåŠŸ');
    } else {
        console.log('DEBUG: æœªæ‰¾åˆ°æ–‡ç« ', articleId, 'çš„DOMå…ƒç´ ');
    }
    
    // åŠ è½½æ–‡ç« å†…å®¹
    fetch('/article/' + articleId + '/content')
        .then(function(response) {
            if (!response.ok) {
                throw new Error('æ–‡ç« ä¸å­˜åœ¨');
            }
            return response.json();
        })
        .then(function(data) {
            console.log('DEBUG: æˆåŠŸåŠ è½½æ–‡ç« ', articleId, 'å†…å®¹');
            // ä¿å­˜æ–‡ç« ä½œè€…ID
            currentArticleAuthorId = data.author_id;
            
            var contentArea = document.getElementById('article-content');
            contentArea.innerHTML =
                '<div class="card">' +
                (data.can_edit ?
                '<div class="article-actions-top">' +
                    '<a href="/article/' + articleId + '/edit" class="action-link edit">âœï¸ ç¼–è¾‘</a>' +
                    '<span class="action-separator">|</span>' +
                    '<a href="#" onclick="showDeleteConfirm(' + articleId + '); return false;" class="action-link delete">ğŸ—‘ï¸ åˆ é™¤</a>' +
                '</div>' : '') +
                '<h1>' + data.title + '</h1>' +
                '<div class="article-content">' + data.content + '</div>' +
                '<div class="article-meta right">' + data.author + ' â€¢ ' + data.created_at + '</div>' +
                '</div>' +
                '<div class="comments-section">' +
                '<h3>ğŸ’¬ è¯„è®º</h3>' +
                '<div class="comment-form">' +
                '<div class="form-group">' +
                '<textarea id="comment-content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3"></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                '<button type="button" onclick="submitComment()" class="btn btn-primary">å‘è¡¨è¯„è®º</button>' +
                '</div>' +
                '</div>' +
                '<div class="comments-list" id="comments-list">' +
                '<div class="loading">åŠ è½½è¯„è®ºä¸­...</div>' +
                '</div>' +
                '</div>';
            
            // ç¡®ä¿å¼¹çª—åœ¨bodyä¸­
            ensureModalExists();
            
            // åŠ è½½è¯„è®º
            loadComments();
        })
        .catch(function(error) {
            console.error('DEBUG: åŠ è½½æ–‡ç« å¤±è´¥:', error);
            // å¦‚æœæ–‡ç« ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½ç¬¬ä¸€ç¯‡æ–‡ç« 
            var firstItem = document.querySelector('.article-item');
            if (firstItem && firstItem.getAttribute('data-article-id') !== articleId.toString()) {
                console.log('DEBUG: å°è¯•åŠ è½½ç¬¬ä¸€ç¯‡æ–‡ç« ä½œä¸ºå¤‡é€‰');
                var firstId = firstItem.getAttribute('data-article-id');
                loadArticle(firstId);
            } else {
                showEmptyState();
            }
        });
}

// é¡µé¢åˆå§‹åŒ–
function initializePage() {
    var params = new URLSearchParams(window.location.search);
    var highlightId = params.get('highlight_id');
    
    console.log('DEBUG: initializePage called');
    console.log('DEBUG: URL =', window.location.href);
    console.log('DEBUG: highlightId =', highlightId);
    
    // å¦‚æœæœ‰highlight_idå‚æ•°ï¼Œä¼˜å…ˆåŠ è½½æŒ‡å®šæ–‡ç« 
    if (highlightId) {
        console.log('DEBUG: å°è¯•åŠ è½½æŒ‡å®šæ–‡ç« ', highlightId);
        var targetItem = document.querySelector('[data-article-id="' + highlightId + '"]');
        if (targetItem) {
            console.log('DEBUG: æ‰¾åˆ°æŒ‡å®šæ–‡ç« å…ƒç´ ï¼ŒåŠ è½½æ–‡ç« ', highlightId);
            loadArticle(highlightId);
            return;
        } else {
            console.log('DEBUG: æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ', highlightId, 'çš„å…ƒç´ ï¼Œfallbackåˆ°åˆ†ç»„ç¬¬ä¸€ç¯‡');
        }
    }
    
    // å¦‚æœæ²¡æœ‰highlight_idï¼Œæ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç»„é¡µç å‚æ•°
    var groupFirstArticle = null;
    for (var key of params.keys()) {
        if (key.startsWith('page_')) {
            var groupName = key.substring(5); // ç§»é™¤ 'page_' å‰ç¼€
            console.log('DEBUG: æ£€æµ‹åˆ°åˆ†ç»„å‚æ•°:', key, 'åˆ†ç»„å:', groupName);
            
            // æŸ¥æ‰¾è¯¥åˆ†ç»„çš„ç¬¬ä¸€ç¯‡æ–‡ç« 
            var groupList = document.getElementById('group-list-' + groupName);
            if (groupList) {
                var firstItemInGroup = groupList.querySelector('.article-item');
                if (firstItemInGroup) {
                    groupFirstArticle = firstItemInGroup;
                    console.log('DEBUG: æ‰¾åˆ°åˆ†ç»„', groupName, 'çš„ç¬¬ä¸€ç¯‡æ–‡ç« :', firstItemInGroup.getAttribute('data-article-id'));
                    break;
                }
            }
        }
    }
    
    // å¦‚æœæ‰¾åˆ°äº†åˆ†ç»„çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼ŒåŠ è½½å®ƒ
    if (groupFirstArticle) {
        var groupFirstId = groupFirstArticle.getAttribute('data-article-id');
        console.log('DEBUG: åŠ è½½åˆ†ç»„ç¬¬ä¸€ç¯‡æ–‡ç« ', groupFirstId);
        loadArticle(groupFirstId);
        return;
    }
    
    // å¦åˆ™åŠ è½½å…¨å±€ç¬¬ä¸€ç¯‡æ–‡ç« 
    var firstItem = document.querySelector('.article-item');
    if (firstItem) {
        var firstId = firstItem.getAttribute('data-article-id');
        console.log('DEBUG: åŠ è½½å…¨å±€ç¬¬ä¸€ç¯‡æ–‡ç« ', firstId);
        loadArticle(firstId);
    } else {
        console.log('DEBUG: æ²¡æœ‰æ–‡ç« ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
        showEmptyState();
    }
}

// æŠ˜å /å±•å¼€åˆ†ç»„
function toggleGroup(category) {
    var content = document.getElementById('group-content-' + category);
    var arrow = document.getElementById('arrow-' + category);
    if (content.style.display === 'none') {
        content.style.display = '';
        if (arrow) arrow.innerHTML = "&or;"; // å±•å¼€æ—¶"âˆ¨"
    } else {
        content.style.display = 'none';
        if (arrow) arrow.innerHTML = "&gt;"; // æ”¶èµ·æ—¶">"
    }
}

// ç®€å•çš„åˆ é™¤ç¡®è®¤å¼¹çª—
function showDeleteConfirm(articleId) {
    console.log('DEBUG: showDeleteConfirm called for article', articleId);
    
    // ç§»é™¤æ—§å¼¹çª—
    var oldModal = document.getElementById('delete-modal');
    if (oldModal) oldModal.remove();
    
    // åˆ›å»ºæ–°å¼¹çª—
    var modal = document.createElement('div');
    modal.id = 'delete-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    var dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white; border-radius: 12px; padding: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        text-align: center; min-width: 300px;
    `;
    
    dialog.innerHTML = `
        <div style="font-size: 1.2rem; margin-bottom: 1rem; color: #d32f2f;">
            âš ï¸ ç¡®è®¤åˆ é™¤
        </div>
        <div style="margin-bottom: 1.5rem; color: #333;">
            ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
        </div>
        <div>
            <button onclick="document.getElementById('delete-modal').remove()" 
                    style="padding: 0.5rem 1.5rem; margin-right: 1rem; border: 1px solid #ccc; 
                           background: white; border-radius: 6px; cursor: pointer;">
                å–æ¶ˆ
            </button>
            <button onclick="deleteArticle(${articleId}); document.getElementById('delete-modal').remove()" 
                    style="padding: 0.5rem 1.5rem; border: none; background: #f44336; 
                           color: white; border-radius: 6px; cursor: pointer;">
                åˆ é™¤
            </button>
        </div>
    `;
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // ç‚¹å‡»é®ç½©å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// åˆ é™¤æ–‡ç« å‡½æ•°
function deleteArticle(articleId) {
    console.log('DEBUG: åˆ é™¤æ–‡ç« ', articleId);
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/article/' + articleId + '/delete';
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

// é¦–é¡µé“¾æ¥å¤„ç† - ç§»é™¤å¹²æ‰°çš„è·³è½¬é€»è¾‘
function handleHomeClick(e) {
    // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œç›´æ¥è·³è½¬
    window.location.href = '/';
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DEBUG: DOMContentLoaded fired');
    
    // ç¨å¾®å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
    setTimeout(function() {
        initializePage();
    }, 100);
    
    // ç»‘å®šé¦–é¡µé“¾æ¥ - ç®€åŒ–å¤„ç†
    var homeLink = document.getElementById('home-link');
    var navHomeLink = document.getElementById('nav-home-link');
    
    if (homeLink) {
        homeLink.addEventListener('click', handleHomeClick);
    }
    if (navHomeLink) {
        navHomeLink.addEventListener('click', handleHomeClick);
    }
    
    // è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»æ¨¡æ¿å˜é‡è·å–ï¼‰
    currentUser = {{ user|tojson if user else 'null' }};
    
    // ç¡®ä¿å¼¹çª—å­˜åœ¨å¹¶è®¾ç½®äº‹ä»¶
    ensureModalExists();
});

// è¯„è®ºç›¸å…³å‡½æ•°
function loadComments() {
    if (!currentArticleId) return;
    
    fetch(`/api/comments/${currentArticleId}`)
        .then(response => response.json())
        .then(data => {
            displayComments(data.comments);
        })
        .catch(error => {
            console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
            const commentsList = document.getElementById('comments-list');
            if (commentsList) {
                commentsList.innerHTML = '<div class="error">åŠ è½½è¯„è®ºå¤±è´¥</div>';
            }
        });
}

function displayComments(comments) {
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    
    if (comments.length === 0) {
        commentsList.innerHTML = '';
        return;
    }
    
    let html = '';
    comments.forEach(comment => {
        html += createCommentHTML(comment);
    });
    commentsList.innerHTML = html;
}

function createCommentHTML(comment) {
    const authorName = comment.user ? comment.user.username : (comment.anonymous_name || 'åŒ¿åç”¨æˆ·');
    // æ£€æŸ¥æƒé™ï¼šè¯„è®ºä½œè€…æˆ–æ–‡ç« ä½œè€…å¯ä»¥åˆ é™¤
    const canDelete = (comment.user && currentUser && comment.user.id === currentUser.id) || 
                     (currentUser && currentUser.id === currentArticleAuthorId);
    
    let html = `
        <div class="comment" data-comment-id="${comment.id}">
            <div class="comment-header">
                <span class="comment-author">${authorName}</span>
                <span class="comment-time">${comment.created_at}</span>
                ${canDelete ? `<button onclick="deleteComment(${comment.id})" class="delete-btn">åˆ é™¤</button>` : ''}
            </div>
            <div class="comment-content">${comment.content}</div>
            <div class="comment-actions">
                <button onclick="showReplyForm(${comment.id})" class="reply-btn">å›å¤</button>
            </div>
            <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
                <textarea placeholder="å›å¤è¯„è®º..." rows="2"></textarea>
                <button onclick="submitReply(${comment.id})" class="btn btn-primary">å›å¤</button>
                <button onclick="hideReplyForm(${comment.id})" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
            <div class="replies">
    `;
    
    if (comment.replies && comment.replies.length > 0) {
        comment.replies.forEach(reply => {
            html += createReplyHTML(reply);
        });
    }
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function createReplyHTML(reply) {
    const authorName = reply.user ? reply.user.username : (reply.anonymous_name || 'åŒ¿åç”¨æˆ·');
    // æ£€æŸ¥æƒé™ï¼šå›å¤ä½œè€…æˆ–æ–‡ç« ä½œè€…å¯ä»¥åˆ é™¤
    const canDelete = (reply.user && currentUser && reply.user.id === currentUser.id) || 
                     (currentUser && currentUser.id === currentArticleAuthorId);
    
    let html = `
        <div class="reply" data-comment-id="${reply.id}">
            <div class="comment-header">
                <span class="comment-author">${authorName}</span>
                <span class="comment-time">${reply.created_at}</span>
                ${canDelete ? `<button onclick="deleteComment(${reply.id})" class="delete-btn">åˆ é™¤</button>` : ''}
            </div>
            <div class="comment-content">${reply.content}</div>
            <div class="comment-actions">
                <button onclick="showReplyForm(${reply.id})" class="reply-btn">å›å¤</button>
            </div>
            <div class="reply-form" id="reply-form-${reply.id}" style="display: none;">
                <textarea placeholder="å›å¤è¯„è®º..." rows="2"></textarea>
                <button onclick="submitReply(${reply.id})" class="btn btn-primary">å›å¤</button>
                <button onclick="hideReplyForm(${reply.id})" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
            <div class="replies">
    `;
    
    // é€’å½’æ˜¾ç¤ºåµŒå¥—å›å¤
    if (reply.replies && reply.replies.length > 0) {
        reply.replies.forEach(nestedReply => {
            html += createReplyHTML(nestedReply);
        });
    }
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function submitComment() {
    console.log('DEBUG: submitComment å‡½æ•°è¢«è°ƒç”¨');
    
    if (!currentArticleId) {
        console.error('å½“å‰æ²¡æœ‰åŠ è½½æ–‡ç« ï¼Œæ— æ³•å‘è¡¨è¯„è®º');
        alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡æ–‡ç« å†å‘è¡¨è¯„è®º');
        return;
    }
    
    const content = document.getElementById('comment-content').value.trim();
    
    console.log('DEBUG: è¯„è®ºå†…å®¹:', content);
    
    if (!content) {
        console.log('DEBUG: è¯„è®ºå†…å®¹ä¸ºç©ºï¼Œæ˜¾ç¤ºå¼¹çª—');
        showEmptyCommentModal();
        return;
    }
    
    console.log('DEBUG: æäº¤è¯„è®ºï¼Œæ–‡ç« ID:', currentArticleId, 'å†…å®¹:', content);
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('article_id', currentArticleId);
    
    fetch('/api/comments', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: è¯„è®ºæäº¤æˆåŠŸ:', data);
        document.getElementById('comment-content').value = '';
        loadComments(); // é‡æ–°åŠ è½½è¯„è®º
    })
    .catch(error => {
        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
        alert('æäº¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

function submitReply(parentId) {
    if (!currentArticleId) return;
    
    const replyForm = document.getElementById(`reply-form-${parentId}`);
    const textarea = replyForm.querySelector('textarea');
    
    const content = textarea.value.trim();
    
    if (!content) {
        showEmptyCommentModal('å›å¤');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('article_id', currentArticleId);
    formData.append('parent_id', parentId);
    
    fetch('/api/comments', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        textarea.value = '';
        hideReplyForm(parentId);
        loadComments(); // é‡æ–°åŠ è½½è¯„è®º
    })
    .catch(error => {
        console.error('æäº¤å›å¤å¤±è´¥:', error);
        alert('æäº¤å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

function showReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'none';
}

function deleteComment(commentId) {
    showDeleteCommentConfirm(commentId);
}

function showDeleteCommentConfirm(commentId) {
    console.log('DEBUG: showDeleteCommentConfirm called for comment', commentId);
    
    // ç§»é™¤æ—§å¼¹çª—
    var oldModal = document.getElementById('delete-comment-modal');
    if (oldModal) oldModal.remove();
    
    // åˆ›å»ºæ–°å¼¹çª—
    var modal = document.createElement('div');
    modal.id = 'delete-comment-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    var dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white; border-radius: 12px; padding: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        text-align: center; min-width: 300px;
    `;
    
    dialog.innerHTML = `
        <div style="font-size: 1.2rem; margin-bottom: 1rem; color: #d32f2f;">
            âš ï¸ ç¡®è®¤åˆ é™¤
        </div>
        <div style="margin-bottom: 1.5rem; color: #333;">
            ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
        </div>
        <div>
            <button onclick="document.getElementById('delete-comment-modal').remove()" 
                    style="padding: 0.5rem 1.5rem; margin-right: 1rem; border: 1px solid #ccc; 
                           background: white; border-radius: 6px; cursor: pointer;">
                å–æ¶ˆ
            </button>
            <button onclick="confirmDeleteComment(${commentId}); document.getElementById('delete-comment-modal').remove()" 
                    style="padding: 0.5rem 1.5rem; border: none; background: #f44336; 
                           color: white; border-radius: 6px; cursor: pointer;">
                åˆ é™¤
            </button>
        </div>
    `;
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // ç‚¹å‡»é®ç½©å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function confirmDeleteComment(commentId) {
    console.log('DEBUG: åˆ é™¤è¯„è®º', commentId);
    
    fetch(`/api/comments/${commentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        loadComments(); // é‡æ–°åŠ è½½è¯„è®º
    })
    .catch(error => {
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
        alert('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

function showEmptyCommentModal(type = 'è¯„è®º') {
    console.log('DEBUG: showEmptyCommentModal è¢«è°ƒç”¨ï¼Œç±»å‹:', type);
    
    const modal = document.getElementById('empty-comment-modal');
    console.log('DEBUG: å¼¹çª—å…ƒç´ :', modal);
    
    if (!modal) {
        console.error('å¼¹çª—å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¼¹çª—');
        ensureModalExists();
        // é‡æ–°è·å–å¼¹çª—å…ƒç´ 
        const newModal = document.getElementById('empty-comment-modal');
        if (!newModal) {
            console.error('åˆ›å»ºå¼¹çª—å¤±è´¥');
            alert(`è¯·è¾“å…¥${type}å†…å®¹`);
            return;
        }
        // æ›´æ–°æ¶ˆæ¯
        const message = newModal.querySelector('#modal-message');
        if (message) {
            message.textContent = `è¯·è¾“å…¥${type}å†…å®¹`;
        }
        // æ˜¾ç¤ºå¼¹çª—
        newModal.style.display = 'flex';
        setTimeout(() => {
            newModal.classList.add('modal-show');
        }, 10);
        return;
    }
    
    const message = document.getElementById('modal-message');
    if (message) {
        message.textContent = `è¯·è¾“å…¥${type}å†…å®¹`;
    }
    
    console.log('DEBUG: æ˜¾ç¤ºå¼¹çª—');
    modal.style.display = 'flex';
    // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿç¡®ä¿æ˜¾ç¤ºåŠ¨ç”»æ­£å¸¸å·¥ä½œ
    setTimeout(() => {
        modal.style.opacity = '1';
        const content = modal.querySelector('.modal-content');
        if (content) {
            content.style.transform = 'scale(1) translateY(0)';
        }
        console.log('DEBUG: å¼¹çª—å·²æ˜¾ç¤ºï¼Œå…ƒç´ :', modal);
        console.log('DEBUG: å¼¹çª—æ ·å¼:', modal.style.cssText);
    }, 10);
}

function hideEmptyCommentModal() {
    const modal = document.getElementById('empty-comment-modal');
    if (!modal) {
        console.error('å¼¹çª—å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    modal.style.opacity = '0';
    const content = modal.querySelector('.modal-content');
    if (content) {
        content.style.transform = 'scale(0.9) translateY(20px)';
    }
    
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// ç¡®ä¿å¼¹çª—å­˜åœ¨
function ensureModalExists() {
    let modal = document.getElementById('empty-comment-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'empty-comment-modal';
        modal.className = 'modal-overlay';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        modal.innerHTML = `
            <div class="modal-content" style="
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                padding: 0;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(5, 150, 105, 0.15), 0 8px 24px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(5, 150, 105, 0.1);
                transform: scale(0.9) translateY(20px);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 3px;
                    background: linear-gradient(90deg, #059669, #10b981, #34d399);
                "></div>
                <div class="modal-header" style="
                    padding: 1.5rem 1.5rem 0.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid rgba(5, 150, 105, 0.1);
                ">
                    <h3 style="
                        margin: 0;
                        color: #166534;
                        font-size: 1.25rem;
                        font-weight: 600;
                    ">ğŸ“ æç¤º</h3>
                    <button class="modal-close" onclick="hideEmptyCommentModal()" style="
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        color: #6b7280;
                        cursor: pointer;
                        padding: 0.25rem;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                        line-height: 1;
                    ">&times;</button>
                </div>
                <div class="modal-body" style="
                    padding: 1.5rem;
                ">
                    <p id="modal-message" style="
                        margin: 0;
                        color: #374151;
                        font-size: 1rem;
                        line-height: 1.6;
                        text-align: center;
                    ">è¯·è¾“å…¥è¯„è®ºå†…å®¹</p>
                </div>
                <div class="modal-footer" style="
                    padding: 0.5rem 1.5rem 1.5rem;
                    display: flex;
                    justify-content: center;
                    gap: 1rem;
                ">
                    <button class="btn btn-primary" onclick="hideEmptyCommentModal()" style="
                        padding: 0.75rem 2rem;
                        font-size: 0.95rem;
                        font-weight: 600;
                        border-radius: 10px;
                        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
                        border: none;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
                    ">ç¡®å®š</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        setupModalEvents();
    }
}

// ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
function setupModalEvents() {
    const modal = document.getElementById('empty-comment-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideEmptyCommentModal();
            }
        });
    }
    
    // ESCé”®å…³é—­å¼¹çª—
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('empty-comment-modal');
            if (modal && modal.style.display === 'flex') {
                hideEmptyCommentModal();
            }
        }
    });
}
</script>
<style>
.collapsible {
    cursor: pointer;
    user-select: none;
    font-weight: 400;
    font-size: 1.02em;
    color: #6a7c6a;
    padding: 2px 0 2px 2px;
    display: flex;
    align-items: center;
    transition: color 0.18s;
    border-radius: 4px;
}
.collapsible:hover {
    color: #3d4f3d;
    background: #f6faf6;
}
.collapse-arrow {
    display: inline-block;
    width: 0.9em;
    text-align: center;
    margin-right: 6px;
    font-size: 0.95em;
    color: #b2bdb2;
    font-weight: 300;
    transition: transform 0.2s, color 0.18s;
}
.article-group {
    margin-bottom: 0.7em;
    border: none;
    background: none;
}
.article-list {
    margin-left: 0.5em;
    padding-left: 0.5em;
    border-left: none;
}
.group-count {
    font-size: 0.98em;
    color: #b2bdb2;
    margin-left: 0.3em;
    font-weight: 400;
}
.article-item.active {
    background: #eafbe6;
    border-radius: 4px;
    color: #2d4f2d;
}
/* Modal styles now in style.css */
</style>
{% endblock %}