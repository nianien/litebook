{% extends "base.html" %}
{% block content %}
<div class="layout-split">
    <!-- Â∑¶‰æßÂå∫ÂüüÔºöËã•Êúâ grouped_data ÂàôÂ±ïÁ§∫ÂàÜÁªÑÂàóË°®ÔºåÂê¶ÂàôÂ±ïÁ§∫Êé®Ëçê -->
    <div class="sidebar">
        {% if grouped_data %}
            <h2>üìö ÊñáÁ´†ÂàóË°®</h2>
            {% for group in grouped_data %}
            {% set cat_id = group.category|replace(' ', '_')|replace('Ôºà', '_')|replace('Ôºâ', '_')|replace('(', '_')|replace(')', '_')|replace('/', '_')|replace('\\', '_') %}
            <div class="article-group">
                <div class="article-group-title collapsible" onclick="toggleGroup('{{ cat_id }}')" id="group-title-{{ cat_id }}">
                    <span class="collapse-arrow" id="arrow-{{ cat_id }}">&gt;</span> {{ group.category }}<span class="group-count">Ôºà{{ group.total_articles }}Ôºâ</span>
                </div>
                <div class="group-content" id="group-content-{{ cat_id }}">
                    <ul class="article-list" id="group-list-{{ cat_id }}">
                        {% for article in group.articles %}
                        <li class="article-item" data-article-id="{{ article.id }}" onclick="loadArticle(parseInt(this.getAttribute('data-article-id')))">
                            <div class="article-title">{{ article.title }}</div>
                            <div class="article-meta">
                                <span class="article-author">{{ article.author.nickname or article.author.username }}</span>
                                <span class="article-date">{{ article.created_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="pagination-controls">
                        {% set n = group.total_pages %}
                        {% set x = group.current_page %}
                        {% set cat = cat_id %}
                        {% if n > 1 %}
                            {% if x == 1 %}
                                <span class="page-link active">1</span>
                                {% if n > 1 %}
                                    <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ x+1 }}&default_group={{ cat }}#group-{{ cat }}">&gt;</a>
                                    <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ n }}&default_group={{ cat }}#group-{{ cat }}">&gt;&gt;</a>
                                {% endif %}
                            {% elif x == n %}
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}=1&default_group={{ cat }}#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ x-1 }}&default_group={{ cat }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ n }}</span>
                            {% else %}
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}=1&default_group={{ cat }}#group-{{ cat }}">&lt;&lt;</a>
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ x-1 }}&default_group={{ cat }}#group-{{ cat }}">&lt;</a>
                                <span class="page-link active">{{ x }}</span>
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ x+1 }}&default_group={{ cat }}#group-{{ cat }}">&gt;</a>
                                <a class="page-link" href="{{ (base_url or '/') }}?page_{{ cat }}={{ n }}&default_group={{ cat }}#group-{{ cat }}">&gt;&gt;</a>
                            {% endif %}
                        {% else %}
                            <span class="page-link active">1</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <h2>‚≠ê ÊñáÁ´†Êé®Ëçê</h2>
            <div class="article-group">
                <div class="article-group-title collapsible" onclick="toggleGroup('latest')" id="group-title-latest">
                    <span class="collapse-arrow" id="arrow-latest">&gt;</span> ÊúÄÊñ∞ÊñáÁ´†
                </div>
                <div class="group-content" id="group-content-latest">
                <ul class="article-list" id="group-list-latest">
                    {% for article in latest_articles %}
                    <li class="article-item" data-article-id="{{ article.id }}" onclick="loadArticle(parseInt(this.getAttribute('data-article-id')))">
                        <div class="article-title">{{ article.title }}</div>
                        <div class="article-meta">
                            <span class="article-author">{{ article.author.nickname or article.author.username if article.author else 'ÂåøÂêç' }}</span>
                            <span class="article-date">{{ article.created_at.strftime('%Y-%m-%d') if article.created_at else '' }}</span>
                        </div>
                    </li>
                    {% endfor %}
                    {% if not latest_articles or latest_articles|length == 0 %}
                    <li class="article-item disabled">
                        <div class="article-title">ÊöÇÊó†ÊúÄÊñ∞ÊñáÁ´†</div>
                    </li>
                    {% endif %}
                </ul>
                <div class="pagination-controls">
                    {% set n = total_latest_pages %}
                    {% set x = page_latest %}
                    {% if n > 1 %}
                        {% if x == 1 %}
                            <span class="page-link active">1</span>
                            {% if n > 1 %}
                                <a class="page-link" href="/?page_latest={{ x+1 }}#group-latest">&gt;</a>
                                <a class="page-link" href="/?page_latest={{ n }}#group-latest">&gt;&gt;</a>
                            {% endif %}
                        {% elif x == n %}
                            <a class="page-link" href="/?page_latest=1#group-latest">&lt;&lt;</a>
                            <a class="page-link" href="/?page_latest={{ x-1 }}#group-latest">&lt;</a>
                            <span class="page-link active">{{ n }}</span>
                        {% else %}
                            <a class="page-link" href="/?page_latest=1#group-latest">&lt;&lt;</a>
                            <a class="page-link" href="/?page_latest={{ x-1 }}#group-latest">&lt;</a>
                            <span class="page-link active">{{ x }}</span>
                            <a class="page-link" href="/?page_latest={{ x+1 }}#group-latest">&gt;</a>
                            <a class="page-link" href="/?page_latest={{ n }}#group-latest">&gt;&gt;</a>
                        {% endif %}
                    {% else %}
                        <span class="page-link active">1</span>
                    {% endif %}
                </div>
                </div>
            </div>
            <div class="article-group">
                <div class="article-group-title collapsible" onclick="toggleGroup('hot')" id="group-title-hot">
                    <span class="collapse-arrow" id="arrow-hot">&gt;</span> ÁÉ≠Èó®ÊñáÁ´†
                </div>
                <div class="group-content" id="group-content-hot">
                <ul class="article-list" id="group-list-hot">
                    {% for article in hot_articles %}
                    <li class="article-item" data-article-id="{{ article.id }}" onclick="loadArticle(parseInt(this.getAttribute('data-article-id')))">
                        <div class="article-title">{{ article.title }}</div>
                        <div class="article-meta">
                            <span class="article-author">{{ article.author.nickname or article.author.username if article.author else 'ÂåøÂêç' }}</span>
                            <span class="article-date">{{ article.created_at.strftime('%Y-%m-%d') if article.created_at else '' }}</span>
                        </div>
                    </li>
                    {% endfor %}
                    {% if not hot_articles or hot_articles|length == 0 %}
                    <li class="article-item disabled">
                        <div class="article-title">ÊöÇÊó†ÁÉ≠Èó®ÊñáÁ´†</div>
                    </li>
                    {% endif %}
                </ul>
                <div class="pagination-controls">
                    {% set n = total_hot_pages %}
                    {% set x = page_hot %}
                    {% if n > 1 %}
                        {% if x == 1 %}
                            <span class="page-link active">1</span>
                            {% if n > 1 %}
                                <a class="page-link" href="/?page_hot={{ x+1 }}#group-hot">&gt;</a>
                                <a class="page-link" href="/?page_hot={{ n }}#group-hot">&gt;&gt;</a>
                            {% endif %}
                        {% elif x == n %}
                            <a class="page-link" href="/?page_hot=1#group-hot">&lt;&lt;</a>
                            <a class="page-link" href="/?page_hot={{ x-1 }}#group-hot">&lt;</a>
                            <span class="page-link active">{{ n }}</span>
                        {% else %}
                            <a class="page-link" href="/?page_hot=1#group-hot">&lt;&lt;</a>
                            <a class="page-link" href="/?page_hot={{ x-1 }}#group-hot">&lt;</a>
                            <span class="page-link active">{{ x }}</span>
                            <a class="page-link" href="/?page_hot={{ x+1 }}#group-hot">&gt;</a>
                            <a class="page-link" href="/?page_hot={{ n }}#group-hot">&gt;&gt;</a>
                        {% endif %}
                    {% else %}
                        <span class="page-link active">1</span>
                    {% endif %}
                </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Âè≥‰æßÊñáÁ´†ÂÜÖÂÆπ -->
    <div class="content-area" id="article-content">
        {% if first_article is defined and first_article %}
            <div class="card">
                <h1>{{ first_article.title }}</h1>
                <div class="article-content">{{ first_article.content|safe }}</div>
                <div class="article-meta right">
                    {{ (first_article.author.nickname or first_article.author.username) if first_article.author else 'ÂåøÂêç' }} ‚Ä¢ {{ first_article.created_at.strftime('%Y-%m-%d %H:%M') if first_article.created_at else '' }}
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <h3>üìñ ÈÄâÊã©ÊñáÁ´†</h3>
                <p>‰ªéÂ∑¶‰æßÂàóË°®‰∏≠ÈÄâÊã©‰∏ÄÁØáÊñáÁ´†Êù•ÈòÖËØª</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ÊÄßËÉΩ‰ºòÂåñÁõ∏ÂÖ≥ÂèòÈáè
const PERFORMANCE_CACHE = new Map();
const DEBOUNCE_DELAY = 300;
const THROTTLE_DELAY = 100;
let pendingRequests = new Set();

// ÂÖ®Â±ÄÂèòÈáè
var currentArticleId = null;
var currentUser = null;
var currentArticleAuthorId = null;

// Èò≤ÊäñÂáΩÊï∞
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ËäÇÊµÅÂáΩÊï∞
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// ÁºìÂ≠òÁÆ°ÁêÜ
function getCachedData(key) {
    const cached = PERFORMANCE_CACHE.get(key);
    if (cached && Date.now() - cached.timestamp < 5 * 60 * 1000) {
        return cached.data;
    }
    return null;
}

function setCachedData(key, data) {
    PERFORMANCE_CACHE.set(key, {
        data: data,
        timestamp: Date.now()
    });
}

// ÊòæÁ§∫Á©∫ÁôΩÁä∂ÊÄÅ
function showEmptyState() {
    const contentArea = document.getElementById('article-content');
    if (contentArea) {
        contentArea.innerHTML = 
            '<div class="empty-state">' +
                '<h3>üìñ ÈÄâÊã©ÊñáÁ´†</h3>' +
                '<p>‰ªéÂ∑¶‰æßÂàóË°®‰∏≠ÈÄâÊã©‰∏ÄÁØáÊñáÁ´†Êù•ÈòÖËØª</p>' +
            '</div>';
    }
}

// ‰ºòÂåñÁöÑÂä†ËΩΩÊñáÁ´†ÂÜÖÂÆπ
const loadArticle = debounce(function(articleId) {
    if (!articleId) {
        showEmptyState();
        return;
    }
    
    // Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±Ç
    if (pendingRequests.has(articleId)) {
        return;
    }
    
    // Ê£ÄÊü•ÁºìÂ≠ò
    const cacheKey = 'article_' + articleId;
    const cachedData = getCachedData(cacheKey);
    if (cachedData) {
        // Êõ¥Êñ∞ÂΩìÂâçÊñáÁ´†ID
        currentArticleId = articleId;
        
        // Êõ¥Êñ∞È´ò‰∫ÆÁä∂ÊÄÅ
        document.querySelectorAll('.article-item').forEach(function(item) {
            item.classList.remove('active');
        });
        
        const currentItem = document.querySelector('[data-article-id="' + articleId + '"]');
        if (currentItem) {
            currentItem.classList.add('active');
            currentItem.scrollIntoView({block: 'center', behavior: 'smooth'});
        }
        
        updateArticleDisplay(cachedData);
        // Á°Æ‰øùÂºπÁ™óÂú®body‰∏≠
        ensureModalExists();
        // Âª∂ËøüÂä†ËΩΩËØÑËÆ∫
        setTimeout(() => loadComments(), 50);
        return;
    }
    
    pendingRequests.add(articleId);
    
    // Êõ¥Êñ∞ÂΩìÂâçÊñáÁ´†ID
    currentArticleId = articleId;
    
    // Êõ¥Êñ∞È´ò‰∫ÆÁä∂ÊÄÅ
    document.querySelectorAll('.article-item').forEach(function(item) {
        item.classList.remove('active');
    });
    
    const currentItem = document.querySelector('[data-article-id="' + articleId + '"]');
    if (currentItem) {
        currentItem.classList.add('active');
        currentItem.scrollIntoView({block: 'center', behavior: 'smooth'});
    }
    
    // Âä†ËΩΩÊñáÁ´†ÂÜÖÂÆπ
    fetch('/article/' + articleId + '/content')
        .then(function(response) {
            if (!response.ok) {
                throw new Error('ÊñáÁ´†‰∏çÂ≠òÂú®');
            }
            return response.json();
        })
        .then(function(data) {
            // ÁºìÂ≠òÊï∞ÊçÆ
            setCachedData(cacheKey, data);
            
            // ‰øùÂ≠òÊñáÁ´†‰ΩúËÄÖID
            currentArticleAuthorId = data.author_id;
            
            updateArticleDisplay(data);
            
            // Á°Æ‰øùÂºπÁ™óÂú®body‰∏≠
            ensureModalExists();
        })
        .catch(function(error) {
            console.error('Âä†ËΩΩÊñáÁ´†Â§±Ë¥•:', error);
            // Â¶ÇÊûúÊñáÁ´†‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂä†ËΩΩÁ¨¨‰∏ÄÁØáÊñáÁ´†
            var firstItem = document.querySelector('.article-item');
            if (firstItem && firstItem.getAttribute('data-article-id') !== articleId.toString()) {
                var firstId = firstItem.getAttribute('data-article-id');
                loadArticle(firstId);
            } else {
                showEmptyState();
            }
        })
        .finally(() => {
            pendingRequests.delete(articleId);
        });
}, DEBOUNCE_DELAY);

// ‰ºòÂåñÁöÑÊñáÁ´†ÊòæÁ§∫Êõ¥Êñ∞
function updateArticleDisplay(data) {
    const contentArea = document.getElementById('article-content');
    if (!contentArea) return;
    
    // ‰ΩøÁî®ÊñáÊ°£ÁâáÊÆµÂáèÂ∞ëÈáçÊéí
    const fragment = document.createDocumentFragment();
    const articleDiv = document.createElement('div');
    
    // ÂàõÂª∫HTMLÁªìÊûÑÔºå‰ΩÜ‰∏çÂåÖÂê´ÊñáÁ´†ÂÜÖÂÆπ
    articleDiv.innerHTML =
        '<div class="card">' +
        (data.can_edit ?
        '<div class="article-actions-top">' +
            '<a href="/article/' + currentArticleId + '/edit" class="action-link edit">‚úèÔ∏è ÁºñËæë</a>' +
            '<span class="action-separator">|</span>' +
            '<a href="#" onclick="showDeleteConfirm(' + currentArticleId + '); return false;" class="action-link delete">üóëÔ∏è Âà†Èô§</a>' +
        '</div>' : '') +
        '<h1>' + data.title + '</h1>' +
        '<div class="article-content"></div>' +
        '<div class="article-meta right">' + data.author + ' ‚Ä¢ ' + data.created_at + '</div>' +
        '</div>' +
        '<div class="comments-section">' +
        '<h3>üí¨ ËØÑËÆ∫</h3>' +
        '<div class="comment-form">' +
        '<div class="form-group">' +
        '<textarea id="comment-content" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..." rows="3"></textarea>' +
        '</div>' +
        '<div class="form-group">' +
        '<button type="button" onclick="submitComment()" class="btn btn-primary">ÂèëË°®ËØÑËÆ∫</button>' +
        '</div>' +
        '</div>' +
        '<div class="comments-list" id="comments-list">' +
        '<div class="loading">Âä†ËΩΩËØÑËÆ∫‰∏≠...</div>' +
        '</div>' +
        '</div>';
    
    fragment.appendChild(articleDiv);
    contentArea.innerHTML = '';
    contentArea.appendChild(fragment);
    
    // ÁÑ∂ÂêéÂçïÁã¨ËÆæÁΩÆÊñáÁ´†ÂÜÖÂÆπÔºåÈÅøÂÖçËΩ¨‰πâ
    const articleContentDiv = contentArea.querySelector('.article-content');
    if (articleContentDiv) {
        articleContentDiv.innerHTML = data.content || '';
    }
    
    // Âª∂ËøüÂä†ËΩΩËØÑËÆ∫
    setTimeout(() => loadComments(), 50);
}

// È°µÈù¢ÂàùÂßãÂåñ
function initializePage() {
    const params = new URLSearchParams(window.location.search);
    const highlightId = params.get('highlight_id');
    const defaultGroup = params.get('default_group');
    
    // Â¶ÇÊûúÊúâhighlight_idÂèÇÊï∞Ôºå‰ºòÂÖàÂä†ËΩΩÊåáÂÆöÊñáÁ´†
    if (highlightId) {
        const targetItem = document.querySelector('[data-article-id="' + highlightId + '"]');
        if (targetItem) {
            loadArticle(highlightId);
            return;
        }
    }
    
    // Ëã•ÊåáÂÆöÈªòËÆ§ÂàÜÁªÑÔºå‰ºòÂÖàÂä†ËΩΩËØ•ÂàÜÁªÑÁöÑÁ¨¨‰∏ÄÁØáÊñáÁ´†
    if (defaultGroup) {
        const groupList = document.getElementById('group-list-' + defaultGroup);
        if (groupList) {
            const firstInGroup = groupList.querySelector('.article-item');
            if (firstInGroup) {
                const firstId = firstInGroup.getAttribute('data-article-id');
                loadArticle(firstId);
                return;
            }
        }
    }

    // ÂÖúÂ∫ïÔºöÂä†ËΩΩÈ°µÈù¢‰∏≠ÁöÑÁ¨¨‰∏ÄÁØáÊñáÁ´†
    const firstItem = document.querySelector('.article-item');
    if (firstItem) {
        const firstId = firstItem.getAttribute('data-article-id');
        loadArticle(firstId);
    } else {
        showEmptyState();
    }
}

// ‰ºòÂåñÁöÑÊäòÂè†/Â±ïÂºÄÂàÜÁªÑ
const toggleGroup = throttle(function(category) {
    const content = document.getElementById('group-content-' + category);
    const arrow = document.getElementById('arrow-' + category);
    if (content.style.display === 'none') {
        content.style.display = '';
        if (arrow) arrow.innerHTML = "&or;";
        try { localStorage.setItem('group_open_' + category, '1'); } catch (e) {}
    } else {
        content.style.display = 'none';
        if (arrow) arrow.innerHTML = "&gt;";
        try { localStorage.setItem('group_open_' + category, '0'); } catch (e) {}
    }
}, THROTTLE_DELAY);

// Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó
function showDeleteConfirm(articleId) {
    const oldModal = document.getElementById('delete-modal');
    if (oldModal) oldModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'delete-modal';
    modal.style.cssText = 
        'position: fixed; top: 0; left: 0; right: 0; bottom: 0;' +
        'background: rgba(0,0,0,0.5); z-index: 2000;' +
        'display: flex; align-items: center; justify-content: center;';
    
    const dialog = document.createElement('div');
    dialog.style.cssText = 
        'background: white; border-radius: 12px; padding: 2rem;' +
        'box-shadow: 0 8px 32px rgba(0,0,0,0.2);' +
        'text-align: center; min-width: 300px;';
    
    dialog.innerHTML = 
        '<div style="font-size: 1.2rem; margin-bottom: 1rem; color: #d32f2f;">' +
            '‚ö†Ô∏è Á°ÆËÆ§Âà†Èô§' +
        '</div>' +
        '<div style="margin-bottom: 1.5rem; color: #333;">' +
            'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÊñáÁ´†ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ' +
        '</div>' +
        '<div>' +
            '<button onclick="document.getElementById(\'delete-modal\').remove()" ' +
                    'style="padding: 0.5rem 1.5rem; margin-right: 1rem; border: 1px solid #ccc; ' +
                           'background: white; border-radius: 6px; cursor: pointer;">' +
                'ÂèñÊ∂à' +
            '</button>' +
            '<button onclick="deleteArticle(' + articleId + '); document.getElementById(\'delete-modal\').remove()" ' +
                    'style="padding: 0.5rem 1.5rem; border: none; background: #f44336; ' +
                           'color: white; border-radius: 6px; cursor: pointer;">' +
                'Âà†Èô§' +
            '</button>' +
        '</div>';
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Âà†Èô§ÊñáÁ´†ÂáΩÊï∞
function deleteArticle(articleId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/article/' + articleId + '/delete';
    form.style.display = 'none';
    document.body.appendChild(form);
    form.submit();
}

// È¶ñÈ°µÈìæÊé•Â§ÑÁêÜ
function handleHomeClick(e) {
    window.location.href = '/';
}

// ‰ºòÂåñÁöÑËØÑËÆ∫Âä†ËΩΩ
const loadComments = debounce(function() {
    if (!currentArticleId) return;
    
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    
    const cacheKey = 'comments_' + currentArticleId;
    const cachedComments = getCachedData(cacheKey);
    
    // Â¶ÇÊûúÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÁõ¥Êé•ÊòæÁ§∫
    if (cachedComments) {
        displayComments(cachedComments);
        return;
    }
    
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    commentsList.innerHTML = '<div class="loading">Âä†ËΩΩËØÑËÆ∫‰∏≠...</div>';
    
    fetch('/api/comments/' + currentArticleId)
        .then(response => response.json())
        .then(data => {
            setCachedData(cacheKey, data.comments);
            displayComments(data.comments);
        })
        .catch(error => {
            console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error);
            if (commentsList) {
                commentsList.innerHTML = '<div class="error">Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•</div>';
            }
        });
}, DEBOUNCE_DELAY);

// ‰ºòÂåñÁöÑËØÑËÆ∫ÊòæÁ§∫
function displayComments(comments) {
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<div class="no-comments">ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫ÂêßÔºÅ</div>';
        return;
    }
    
    // ‰ΩøÁî®ÊñáÊ°£ÁâáÊÆµ‰ºòÂåñDOMÊìç‰Ωú
    const fragment = document.createDocumentFragment();
    comments.forEach(comment => {
        const commentElement = document.createElement('div');
        commentElement.innerHTML = createCommentHTML(comment);
        fragment.appendChild(commentElement.firstElementChild);
    });
    
    commentsList.innerHTML = '';
    commentsList.appendChild(fragment);
}

function createCommentHTML(comment) {
    // ‰ºòÂÖà‰ΩøÁî® display_nameÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® username Êàñ anonymous_name
    const authorName = comment.user ? (comment.user.display_name || comment.user.username) : (comment.anonymous_name || 'ÂåøÂêçÁî®Êà∑');
    const canDelete = (comment.user && currentUser && comment.user.id === currentUser.id) || 
                     (currentUser && currentUser.id === currentArticleAuthorId);
    
    let html = 
        '<div class="comment" data-comment-id="' + comment.id + '">' +
            '<div class="comment-header">' +
                '<span class="comment-author">' + authorName + '</span>' +
                '<span class="comment-time">' + comment.created_at + '</span>' +
                (canDelete ? '<button onclick="deleteComment(' + comment.id + ')" class="delete-btn">Âà†Èô§</button>' : '') +
            '</div>' +
            '<div class="comment-content">' + comment.content + '</div>' +
            '<div class="comment-actions">' +
                '<button onclick="showReplyForm(' + comment.id + ')" class="reply-btn">ÂõûÂ§ç</button>' +
            '</div>' +
            '<div class="reply-form" id="reply-form-' + comment.id + '" style="display: none;">' +
                '<textarea placeholder="ÂõûÂ§çËØÑËÆ∫..." rows="2"></textarea>' +
                '<button onclick="submitReply(' + comment.id + ')" class="btn btn-primary">ÂõûÂ§ç</button>' +
                '<button onclick="hideReplyForm(' + comment.id + ')" class="btn btn-secondary">ÂèñÊ∂à</button>' +
            '</div>' +
            '<div class="replies">';
    
    if (comment.replies && comment.replies.length > 0) {
        comment.replies.forEach(reply => {
            html += createReplyHTML(reply);
        });
    }
    
    html += 
            '</div>' +
        '</div>';
    
    return html;
}

function createReplyHTML(reply) {
    // ‰ºòÂÖà‰ΩøÁî® display_nameÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® username Êàñ anonymous_name
    const authorName = reply.user ? (reply.user.display_name || reply.user.username) : (reply.anonymous_name || 'ÂåøÂêçÁî®Êà∑');
    const canDelete = (reply.user && currentUser && reply.user.id === currentUser.id) || 
                     (currentUser && currentUser.id === currentArticleAuthorId);
    
    let html = 
        '<div class="reply" data-comment-id="' + reply.id + '">' +
            '<div class="comment-header">' +
                '<span class="comment-author">' + authorName + '</span>' +
                '<span class="comment-time">' + reply.created_at + '</span>' +
                (canDelete ? '<button onclick="deleteComment(' + reply.id + ')" class="delete-btn">Âà†Èô§</button>' : '') +
            '</div>' +
            '<div class="comment-content">' + reply.content + '</div>' +
            '<div class="comment-actions">' +
                '<button onclick="showReplyForm(' + reply.id + ')" class="reply-btn">ÂõûÂ§ç</button>' +
            '</div>' +
            '<div class="reply-form" id="reply-form-' + reply.id + '" style="display: none;">' +
                '<textarea placeholder="ÂõûÂ§çËØÑËÆ∫..." rows="2"></textarea>' +
                '<button onclick="submitReply(' + reply.id + ')" class="btn btn-primary">ÂõûÂ§ç</button>' +
                '<button onclick="hideReplyForm(' + reply.id + ')" class="btn btn-secondary">ÂèñÊ∂à</button>' +
            '</div>' +
            '<div class="replies">';
    
    if (reply.replies && reply.replies.length > 0) {
        reply.replies.forEach(nestedReply => {
            html += createReplyHTML(nestedReply);
        });
    }
    
    html += 
            '</div>' +
        '</div>';
    
    return html;
}

// ‰ºòÂåñÁöÑËØÑËÆ∫Êèê‰∫§
const submitComment = debounce(function() {
    if (!currentArticleId) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏ÄÁØáÊñáÁ´†ÂÜçÂèëË°®ËØÑËÆ∫');
        return;
    }
    
    const content = document.getElementById('comment-content').value.trim();
    
    if (!content) {
        showEmptyCommentModal();
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('article_id', currentArticleId);
    
    fetch('/api/comments', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('comment-content').value = '';
        // Ê∏ÖÈô§Áõ∏ÂÖ≥ÁºìÂ≠ò
        PERFORMANCE_CACHE.delete('comments_' + currentArticleId);
        loadComments();
    })
    .catch(error => {
        console.error('Êèê‰∫§ËØÑËÆ∫Â§±Ë¥•:', error);
        alert('Êèê‰∫§ËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    });
}, DEBOUNCE_DELAY);

// ‰ºòÂåñÁöÑÂõûÂ§çÊèê‰∫§
const submitReply = debounce(function(parentId) {
    if (!currentArticleId) return;
    
    const replyForm = document.getElementById('reply-form-' + parentId);
    const textarea = replyForm.querySelector('textarea');
    
    const content = textarea.value.trim();
    
    if (!content) {
        showEmptyCommentModal('ÂõûÂ§ç');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('article_id', currentArticleId);
    formData.append('parent_id', parentId);
    
    fetch('/api/comments', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        textarea.value = '';
        hideReplyForm(parentId);
        // Ê∏ÖÈô§Áõ∏ÂÖ≥ÁºìÂ≠ò
        PERFORMANCE_CACHE.delete('comments_' + currentArticleId);
        loadComments();
    })
    .catch(error => {
        console.error('Êèê‰∫§ÂõûÂ§çÂ§±Ë¥•:', error);
        alert('Êèê‰∫§ÂõûÂ§çÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    });
}, DEBOUNCE_DELAY);

function showReplyForm(commentId) {
    document.getElementById('reply-form-' + commentId).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById('reply-form-' + commentId).style.display = 'none';
}

function deleteComment(commentId) {
    showDeleteCommentConfirm(commentId);
}

function showDeleteCommentConfirm(commentId) {
    const oldModal = document.getElementById('delete-comment-modal');
    if (oldModal) oldModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'delete-comment-modal';
    modal.style.cssText = 
        'position: fixed; top: 0; left: 0; right: 0; bottom: 0;' +
        'background: rgba(0,0,0,0.5); z-index: 2000;' +
        'display: flex; align-items: center; justify-content: center;';
    
    const dialog = document.createElement('div');
    dialog.style.cssText = 
        'background: white; border-radius: 12px; padding: 2rem;' +
        'box-shadow: 0 8px 32px rgba(0,0,0,0.2);' +
        'text-align: center; min-width: 300px;';
    
    dialog.innerHTML = 
        '<div style="font-size: 1.2rem; margin-bottom: 1rem; color: #d32f2f;">' +
            '‚ö†Ô∏è Á°ÆËÆ§Âà†Èô§' +
        '</div>' +
        '<div style="margin-bottom: 1.5rem; color: #333;">' +
            'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ' +
        '</div>' +
        '<div>' +
            '<button onclick="document.getElementById(\'delete-comment-modal\').remove()" ' +
                    'style="padding: 0.5rem 1.5rem; margin-right: 1rem; border: 1px solid #ccc; ' +
                           'background: white; border-radius: 6px; cursor: pointer;">' +
                'ÂèñÊ∂à' +
            '</button>' +
            '<button onclick="confirmDeleteComment(' + commentId + '); document.getElementById(\'delete-comment-modal\').remove()" ' +
                    'style="padding: 0.5rem 1.5rem; border: none; background: #f44336; ' +
                           'color: white; border-radius: 6px; cursor: pointer;">' +
                'Âà†Èô§' +
            '</button>' +
        '</div>';
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function confirmDeleteComment(commentId) {
    fetch('/api/comments/' + commentId, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            // Ê∏ÖÈô§Áõ∏ÂÖ≥ÁºìÂ≠ò
            PERFORMANCE_CACHE.delete('comments_' + currentArticleId);
            loadComments();
        } else {
            alert('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
        }
    })
    .catch(error => {
        console.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:', error);
        alert('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    });
}

// ÂºπÁ™óÁõ∏ÂÖ≥ÂáΩÊï∞
function showEmptyCommentModal(type) {
    type = type || 'ËØÑËÆ∫';
    const oldModal = document.getElementById('empty-comment-modal');
    if (oldModal) oldModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'empty-comment-modal';
    modal.style.cssText = 
        'position: fixed; top: 0; left: 0; right: 0; bottom: 0;' +
        'background: rgba(0,0,0,0.5); z-index: 2000;' +
        'display: flex; align-items: center; justify-content: center;';
    
    const dialog = document.createElement('div');
    dialog.style.cssText = 
        'background: white; border-radius: 12px; padding: 2rem;' +
        'box-shadow: 0 8px 32px rgba(0,0,0,0.2);' +
        'text-align: center; min-width: 300px;';
    
    dialog.innerHTML = 
        '<div style="font-size: 1.2rem; margin-bottom: 1rem; color: #d32f2f;">' +
            '‚ö†Ô∏è ÂÜÖÂÆπ‰∏∫Á©∫' +
        '</div>' +
        '<div style="margin-bottom: 1.5rem; color: #333;">' +
            'ËØ∑ËæìÂÖ•' + type + 'ÂÜÖÂÆπÂêéÂÜçÊèê‰∫§„ÄÇ' +
        '</div>' +
        '<div>' +
            '<button onclick="document.getElementById(\'empty-comment-modal\').remove()" ' +
                    'style="padding: 0.5rem 1.5rem; border: 1px solid #ccc; ' +
                           'background: white; border-radius: 6px; cursor: pointer;">' +
                'Á°ÆÂÆö' +
            '</button>' +
        '</div>';
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function ensureModalExists() {
    // Á°Æ‰øùÂºπÁ™óÂÆπÂô®Â≠òÂú®
    if (!document.getElementById('modal-container')) {
        const modalContainer = document.createElement('div');
        modalContainer.id = 'modal-container';
        document.body.appendChild(modalContainer);
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // ËÆæÁΩÆÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÔºà‰ª•Â≠óÁ¨¶‰∏≤ÂΩ¢ÂºèÊ≥®ÂÖ•ÔºåÈÅøÂÖçËÑöÊú¨ËØ≠Ê≥ïÈóÆÈ¢òÔºâ
    const userJsonStr = '{{ (user|tojson)|default("null")|e }}';
    try {
        currentUser = JSON.parse(userJsonStr);
    } catch (e) {
        currentUser = null;
    }
    
    // Âª∂ËøüÂàùÂßãÂåñÔºåÁ°Æ‰øùDOMÂÆåÂÖ®ÂáÜÂ§áÂ•Ω
    requestAnimationFrame(() => {
        initializePage();
    });
    
    // ÁªëÂÆöÈ¶ñÈ°µÈìæÊé•
    const homeLink = document.getElementById('home-link');
    const navHomeLink = document.getElementById('nav-home-link');
    
    if (homeLink) {
        homeLink.addEventListener('click', handleHomeClick);
    }
    if (navHomeLink) {
        navHomeLink.addEventListener('click', handleHomeClick);
    }
    
    // Á°Æ‰øùÂºπÁ™óÂ≠òÂú®
    ensureModalExists();

    // ÊÅ¢Â§çÂàÜÁªÑÊäòÂè†Áä∂ÊÄÅÔºàÂê´ÊúÄÊñ∞/ÁÉ≠Èó®‰∏éÂàÜÁ±ªÂàÜÁªÑÔºâ
    try {
        const groups = document.querySelectorAll('[id^="group-content-"]');
        groups.forEach(function(contentEl){
            const id = contentEl.id; // group-content-xxx
            const category = id.substring('group-content-'.length);
            const arrow = document.getElementById('arrow-' + category);
            const saved = localStorage.getItem('group_open_' + category);
            if (saved === '0') {
                contentEl.style.display = 'none';
                if (arrow) arrow.innerHTML = "&gt;";
            } else {
                contentEl.style.display = '';
                if (arrow) arrow.innerHTML = "&or;";
            }
        });
    } catch (e) {}
});

// ÂÆöÊúüÊ∏ÖÁêÜËøáÊúüÁºìÂ≠ò
setInterval(() => {
    const now = Date.now();
    for (const [key, value] of PERFORMANCE_CACHE.entries()) {
        if (now - value.timestamp > 10 * 60 * 1000) { // 10ÂàÜÈíüËøáÊúü
            PERFORMANCE_CACHE.delete(key);
        }
    }
}, 5 * 60 * 1000); // ÊØè5ÂàÜÈíüÊ∏ÖÁêÜ‰∏ÄÊ¨°
</script>
<style>
.collapsible {
    cursor: pointer;
    user-select: none;
    font-weight: 400;
    font-size: 1.02em;
    color: #6a7c6a;
    padding: 2px 0 2px 2px;
    display: flex;
    align-items: center;
    transition: color 0.18s;
    border-radius: 4px;
}
.collapsible:hover {
    color: #3d4f3d;
    background: #f6faf6;
}
.collapse-arrow {
    display: inline-block;
    width: 0.9em;
    text-align: center;
    margin-right: 6px;
    font-size: 0.95em;
    color: #b2bdb2;
    font-weight: 300;
    transition: transform 0.2s, color 0.18s;
}
.article-group {
    margin-bottom: 0.7em;
    border: none;
    background: none;
}
.article-list {
    margin-left: 0.5em;
    padding-left: 0.5em;
    border-left: none;
}
.group-count {
    font-size: 0.98em;
    color: #b2bdb2;
    margin-left: 0.3em;
    font-weight: 400;
}


.no-comments {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
    font-style: italic;
    background: rgba(249, 250, 251, 0.8);
    border-radius: 8px;
    border: 1px dashed #d1d5db;
}

.loading {
    text-align: center;
    padding: 1rem;
    color: #6b7280;
}

.error {
    text-align: center;
    padding: 1rem;
    color: #dc2626;
    background: rgba(254, 242, 242, 0.8);
    border-radius: 8px;
    border: 1px solid #fecaca;
}
/* Modal styles now in style.css */
</style>
{% endblock %}